# Claude Code 协作规范

> **项目**: Kimi's Telegram Bot Services
> **创建时间**: 2026-01-17
> **维护者**: Claude (AI Assistant)

---

## 📋 项目概述

本项目包含两个相关联的 Python 服务，部署在 Zeabur 平台：

1. **Calendar Bot** - 智能日历助手机器人
2. **Singbox Updater** - VPN 配置自动更新服务

**部署方式**: 统一代码仓库，独立服务部署

---

## 🎯 核心原则

### 1. 重构决策权
- **Claude 全权负责**具体重构方案设计和实施
- 基于项目规模和复杂性做出合理判断
- 保持架构清晰，避免过度设计

### 2. 简单性优先
- ❌ **不追求**：微服务化、复杂设计模式、过度抽象
- ✅ **坚持**：实用主义、可读性、可维护性
- ✅ **原则**：能用简单方案解决的，不引入复杂架构

### 3. 部署环境约束
- **平台**: 必须兼容 Zeabur 部署
- **环境变量**: 不改变现有环境变量名称和结构
- **配置**: 保持向后兼容，确保现有服务不中断
- **依赖**: 使用 Zeabur 原生支持的技术栈

### 4. 代码仓库结构
- **统一仓库**: 两个服务合并到同一个 Git 仓库
- **独立部署**: 每个服务独立的 Dockerfile 和部署配置
- **共享代码**: 提取公共模块到 shared/ 目录

### 5. 测试与部署流程
- **无本地测试环境**: 所有开发直接在代码层面完成
- **部署前审计**: Claude 负责代码审计、评估和模拟测试
- **部署策略**: 确认无误后直接推送到 GitHub → Zeabur 自动部署
- **风险控制**: 保留旧版本分支作为回滚备份

### 6. 需求变更管理
- **原则**: 任何功能变更、新需求、架构调整都需要用户确认
- **流程**: Claude 提出方案 → 用户审核 → 确认后执行
- **例外**: Bug 修复、代码优化、文档更新可自主进行

### 7. 外部依赖管理
- **慎重原则**: 任何外部库、工具、软件的引入都需要明确告知
- **说明内容**:
  - 依赖名称和用途
  - 为什么需要引入
  - 对项目的影响
  - 是否有替代方案
- **等待确认**: 获得用户明确同意后才能安装/引入

---

## 🔧 技术栈约束

### 允许的技术选型
- **语言**: Python 3.10+
- **依赖管理**: requirements.txt (Zeabur 原生支持)
- **数据库**: SQLite (轻量级，无需额外服务)
- **容器化**: Docker (Zeabur 要求)
- **CI/CD**: GitHub Actions (可选)

### 谨慎引入的技术
- **ORM**: 如果引入 SQLAlchemy，需评估复杂度
- **异步框架**: asyncio 需评估必要性
- **配置管理**: Pydantic 可用，但不强制
- **类型检查**: mypy 可选，不作为硬性要求

### 避免引入的技术
- ❌ Poetry/Pipenv (Zeabur 兼容性未知)
- ❌ 复杂的消息队列 (Redis/RabbitMQ)
- ❌ 微服务框架
- ❌ 重量级监控系统

---

## 📂 目标代码结构

```
kimi-telegram-bot/
├── services/
│   ├── calendar_bot/
│   │   ├── src/
│   │   ├── main.py
│   │   ├── requirements.txt
│   │   └── Dockerfile
│   │
│   └── singbox_updater/
│       ├── src/
│       ├── main.py
│       ├── requirements.txt
│       └── Dockerfile
│
├── shared/                    # 共享模块（如果需要）
│   └── zeabur_utils/
│
├── docs/                      # 文档
│   ├── deployment.md
│   └── architecture.md
│
├── .github/
│   └── workflows/             # CI/CD（可选）
│
├── .gitignore
├── README.md
└── CLAUDE.md                  # 本文件
```

---

## 🚀 重构执行流程

### Phase 1: 准备阶段
1. 备份现有代码（创建 `backup` 分支）
2. 创建新的目录结构
3. 整理依赖清单

### Phase 2: 代码迁移
1. 保持功能完全一致
2. 逐模块重构和测试
3. 更新文档

### Phase 3: 审计与部署
1. Claude 执行完整代码审计
2. 模拟可能的边界情况
3. 提交部署方案给用户确认
4. 推送到 GitHub

### Phase 4: 验证与监控
1. 在 Zeabur 观察服务启动
2. 验证核心功能
3. 监控日志和错误

---

## ⚠️ 风险控制措施

### 代码层面
- 保持环境变量名称不变
- 保持 API 接口一致
- 保持数据库结构兼容
- 添加详细的错误日志

### 部署层面
- 保留旧版本 Docker 镜像
- 记录所有环境变量配置
- 准备快速回滚方案
- 分服务独立部署（先部署影响小的）

### 沟通层面
- 重大变更前明确告知
- 提供清晰的变更说明
- 遇到不确定情况及时询问

---

## 📝 变更记录

### 2026-01-17 - 初始化
- 创建协作规范文档
- 明确重构原则和约束
- 定义技术栈和流程

---

## 🤝 协作约定

### Claude 的职责
- 负责代码重构和优化
- 确保功能稳定可靠
- 进行代码审计和测试
- 维护文档更新
- 主动识别潜在问题

### 用户的职责
- 确认重大变更和新需求
- 审核部署方案
- 提供业务需求澄清
- 验收最终效果

### 沟通原则
- **透明**: 所有决策和变更公开透明
- **及时**: 重要事项及时沟通确认
- **清晰**: 使用明确的语言，避免歧义
- **尊重**: 相互尊重专业判断

---

**最后更新**: 2026-01-17
**文档版本**: 1.0.0
